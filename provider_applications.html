<!doctype html>
<html lang="ar" dir="rtl" data-theme="auto">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>طلبات المتقدمين | تدريبي</title>
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box}
:root{--brand:#0a66b2;--brand-700:#084a85;--bg:#f5f8fc;--card:#ffffff;--line:#e6eef6;--text:#0d1b2a;--muted:#5d6f82;--shadow:0 12px 40px rgba(10,102,178,.12)}
@media(prefers-color-scheme:dark){:root{--bg:#0c1520;--card:#111c29;--line:#152235;--text:#e8eef6;--muted:#9fb0c3;--shadow:0 12px 40px rgba(0,0,0,.5)}}
html[data-mode="dark"]{--bg:#0c1520;--card:#111c29;--line:#152235;--text:#e8eef6;--muted:#9fb0c3;--shadow:0 12px 40px rgba(0,0,0,.5)}
html[data-mode="light"]{--bg:#f5f8fc;--card:#ffffff;--line:#e6eef6;--text:#0d1b2a;--muted:#5d6f82;--shadow:0 12px 40px rgba(10,102,178,.12)}
body{margin:0;background:var(--bg);color:var(--text);font-family:"Tajawal",system-ui,Arial}
.layout{display:grid;grid-template-columns:240px 1fr;min-height:100vh}
.sidebar{background:var(--card);border-left:1px solid var(--line);position:sticky;top:0;height:100vh;padding:14px 12px;overflow:auto;z-index:60}
.brand{display:flex;align-items:center;gap:10px;padding:6px 8px;margin-bottom:8px;text-decoration:none;color:inherit}
.brand .logo{width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,var(--brand),#46a1ff);display:grid;place-items:center;color:#fff;font-weight:900}
.brand .t{font-weight:900;color:var(--brand);font-size:18px}
.menu{display:flex;flex-direction:column;gap:6px}
.link{display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;color:inherit;text-decoration:none}
.link:hover,.link.active{background:rgba(10,102,178,.08)}
.badge{margin-right:auto;background:rgba(10,102,178,.12);color:var(--brand);border-radius:999px;padding:2px 8px;font-size:12px}
.topbar{position:sticky;top:0;z-index:70;background:rgba(255,255,255,.8);backdrop-filter:saturate(180%) blur(8px);border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;padding:10px 14px}
@media(prefers-color-scheme:dark){.topbar{background:rgba(17,28,41,.65)}}
.topbar .right{display:flex;align-items:center;gap:8px}
.btn{display:inline-flex;align-items:center;gap:8px;background:var(--brand);color:#fff;border:0;border-radius:12px;padding:9px 14px;font-weight:800;cursor:pointer;text-decoration:none}
.btn.ghost{background:transparent;color:var(--brand);border:1px solid var(--line)}
.container{padding:16px;max-width:1320px;margin:0 auto}
.grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
.card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px;box-shadow:var(--shadow)}
.card h3{margin:0 0 8px;font-size:15px;color:var(--muted)}
.kpi{display:flex;align-items:baseline;gap:6px}
.kpi .n{font-size:26px;font-weight:900;color:var(--brand)}
.cols-2{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
.table{width:100%;border-collapse:separate;border-spacing:0 8px}
.table th,.table td{padding:10px;background:var(--card);border:1px solid var(--line)}
.table th{color:var(--muted);font-weight:700}
.table td:first-child,.table th:first-child{border-radius:8px 0 0 8px}
.table td:last-child,.table th:last-child{border-radius:0 8px 8px 0}
.small{font-size:12px;color:var(--muted)}
.flex{display:flex;gap:8px;align-items:center}
.mode{border:1px solid var(--line);background:var(--card);color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
.burger{display:none;border:1px solid var(--line);background:var(--card);color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
.backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);backdrop-filter:blur(2px);z-index:50;opacity:0;visibility:hidden;transition:.25s}
.backdrop.show{opacity:1;visibility:visible}
.toast{position:fixed;top:16px;left:50%;transform:translateX(-50%);background:rgba(10,102,178,.08);color:var(--text);border:1px solid #9ad0ff;border-radius:12px;padding:10px 14px;z-index:90;opacity:0;pointer-events:none;transition:.25s}
.toast.show{opacity:1}
@media(max-width:1200px){.grid{grid-template-columns:1fr 1fr}.cols-2{grid-template-columns:1fr}}
@media(max-width:980px){.layout{grid-template-columns:1fr}.sidebar{position:fixed;inset:0 0 0 auto;width:min(280px,86vw);transform:translateX(100%);transition:transform .25s ease, box-shadow .25s;box-shadow:var(--shadow)}.sidebar.open{transform:translateX(0)}.burger{display:inline-block}}
@media(max-width:720px){.grid{grid-template-columns:1fr}}
.select{padding:6px 8px;border:1px solid var(--line);border-radius:8px;background:transparent;color:var(--text);min-width:180px}
.input{padding:10px;border:1px solid var(--line);border-radius:10px;background:transparent;color:var(--text)}
</style>
</head>
<body>
<div class="layout">
<aside class="sidebar" id="sidebar">
  <a class="brand" href="index.html"><div class="logo">ت</div><div class="t">تدريبي</div></a>
  <nav class="menu">
    <a class="link active" href="index.html">لوحة المزود</a>
    <a class="link" href="provider_listings.html" data-open="listings">فرصي التدريبية</a>
    <a class="link" href="provider_applications.html" data-open="applications">طلبات المتقدمين</a>
    <a class="link" href="provider_settings.html" data-open="settings">إعدادات الحساب</a>
    <a class="link" href="login.html" data-open="logout">خروج</a>
  </nav>
</aside>
<div id="backdrop" class="backdrop"></div>
<main>
  <header class="topbar">
    <div class="right">
      <button id="burger" class="burger" type="button" aria-label="القائمة">☰</button>
      <strong id="hello"></strong>
      <span class="small" id="roleTag"></span>
    </div>
    <div class="right">
      <button id="mode" class="mode" type="button">الوضع: تلقائي</button>
      <a class="btn ghost" href="#">الصفحة الرئيسية</a>
      <a class="btn" href="#">خروج</a>
    </div>
  </header>
  <div class="container">
    <div class="grid" style="margin-bottom:12px">
      <div class="card"><h3>إجمالي الطلبات</h3><div class="kpi"><div class="n" id="k_total">0</div></div></div>
      <div class="card"><h3>قيد المراجعة</h3><div class="kpi"><div class="n" id="k_pending">0</div></div></div>
      <div class="card"><h3>شوهدت</h3><div class="kpi"><div class="n" id="k_viewed">0</div></div></div>
      <div class="card"><h3>مقبول / مرفوض</h3><div class="kpi"><div class="n" id="k_ok">0 / 0</div></div></div>
    </div>
    <div class="card" style="margin-bottom:12px">
      <form id="filterForm" class="flex" style="flex-wrap:wrap;gap:10px">
        <input class="input" type="text" id="q" placeholder="بحث بالاسم/البريد/العنوان" style="flex:1;min-width:260px">
        <select class="select" id="statusF">
          <option value="">كل الحالات</option>
          <option value="pending">قيد المراجعة</option>
          <option value="viewed">شوهد</option>
          <option value="accepted">مقبول</option>
          <option value="rejected">مرفوض</option>
        </select>
        <select class="select" id="listF"></select>
        <select class="select" id="sort">
          <option value="applied_desc">الأحدث تقديمًا</option>
          <option value="applied_asc">الأقدم تقديمًا</option>
          <option value="user_asc">الاسم (أ-ي)</option>
          <option value="user_desc">الاسم (ي-أ)</option>
          <option value="listing_asc">الفرصة (أ-ي)</option>
          <option value="listing_desc">الفرصة (ي-أ)</option>
          <option value="status_asc">الحالة (تصاعدي)</option>
          <option value="status_desc">الحالة (تنازلي)</option>
        </select>
        <button class="btn" type="submit">تصفية</button>
      </form>
      <div class="small" style="margin-top:6px">النتائج: <span id="totalCount">0</span> طلب</div>
    </div>
    <div class="card">
      <table class="table" id="appsTable">
        <thead>
          <tr>
            <th>المتقدم</th>
            <th>البريد</th>
            <th>الفرصة</th>
            <th>المشرف</th>
            <th>الحالة</th>
            <th>تاريخ التقديم</th>
            <th>إجراءات</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="flex" id="pagination" style="justify-content:center;margin-top:10px;flex-wrap:wrap;gap:6px"></div>
    </div>
  </div>
</main>
</div>
<div class="toast" id="toast"></div>
<script>
var uname=localStorage.getItem('tadribi_uname')||'مزود';
var role='provider';
var per=15;
var qState="";
var statusState="";
var listState=0;
var sortState="applied_desc";
var pageState=1;
var listings=JSON.parse(localStorage.getItem('tadribi_provider_listings')||'null')||[
  {id:101,title:'تدريب على التسويق الرقمي',location:'الرياض',duration:'3 أشهر',application_deadline:'2025-10-30',created_at:'2025-09-20 09:10:00'},
  {id:102,title:'برمجة بايثون لطلبة الجامعات',location:'جدة',duration:'6 أسابيع',application_deadline:'2025-10-15',created_at:'2025-09-18 14:22:00'},
  {id:103,title:'تحليل بيانات أولي',location:'الدمام',duration:'8 أسابيع',application_deadline:'2025-11-05',created_at:'2025-09-17 10:05:00'},
  {id:104,title:'تصميم تجربة المستخدم',location:'مكة',duration:'4 أسابيع',application_deadline:'2025-10-05',created_at:'2025-09-15 12:40:00'},
  {id:105,title:'إدارة المشاريع العملية',location:'أبها',duration:'10 أسابيع',application_deadline:'2025-11-20',created_at:'2025-09-12 08:33:00'}
];
var supervisors=JSON.parse(localStorage.getItem('tadribi_supervisors')||'null')||[
  {id:1,name:'د. سامي الحربي',email:'sami@uni.edu'},
  {id:2,name:'م. نوره القحطاني',email:'noura@corp.com'},
  {id:3,name:'أ. ماهر السلمي',email:'maher@academy.org'},
  {id:4,name:'م. رانيا يوسف',email:'raniya@uxlab.io'},
  {id:5,name:'د. فارس الغامدي',email:'fares@health.ai'}
];
var appsDetailed=JSON.parse(localStorage.getItem('tadribi_provider_apps_detailed')||'null');
if(!appsDetailed){
  var base=JSON.parse(localStorage.getItem('tadribi_provider_apps')||'null')||[
    {id:1,uname:'أحمد صالح',uemail:'ahmed@gmail.com',ltitle:'تدريب على التسويق الرقمي',status:'pending',applied_at:'2025-09-21 13:11:00'},
    {id:2,uname:'جمانة خالد',uemail:'jumana@gmail.com',ltitle:'برمجة بايثون لطلبة الجامعات',status:'accepted',applied_at:'2025-09-21 11:09:00'},
    {id:3,uname:'وليد ناصر',uemail:'waleed@gmail.com',ltitle:'تحليل بيانات أولي',status:'rejected',applied_at:'2025-09-20 16:55:00'},
    {id:4,uname:'ريم محمد',uemail:'reem@gmail.com',ltitle:'تصميم تجربة المستخدم',status:'pending',applied_at:'2025-09-20 09:25:00'},
    {id:5,uname:'ليان فهد',uemail:'lian@gmail.com',ltitle:'إدارة المشاريع العملية',status:'pending',applied_at:'2025-09-19 18:47:00'},
    {id:6,uname:'طارق عادل',uemail:'tareq@gmail.com',ltitle:'برمجة بايثون لطلبة الجامعات',status:'pending',applied_at:'2025-09-19 08:10:00'}
  ];
  var extras=[
    {uname:'خالد علي',uemail:'khaled@gmail.com',ltitle:'تحليل بيانات أولي'},
    {uname:'سارة بدر',uemail:'sarah@gmail.com',ltitle:'تصميم تجربة المستخدم'},
    {uname:'نواف منصور',uemail:'nawaf@gmail.com',ltitle:'إدارة المشاريع العملية'},
    {uname:'أميرة هاني',uemail:'amira@gmail.com',ltitle:'تدريب على التسويق الرقمي'},
    {uname:'إسراء يوسف',uemail:'esra@gmail.com',ltitle:'برمجة بايثون لطلبة الجامعات'}
  ];
  var idc=base.length;
  extras.forEach(function(e,i){idc++;var st=['pending','viewed','accepted','rejected'][Math.floor(Math.random()*4)];var d=new Date(2025,8,10+Math.floor(Math.random()*15),8+Math.floor(Math.random()*10),Math.floor(Math.random()*60));base.push({id:idc,uname:e.uname,uemail:e.uemail,ltitle:e.ltitle,status:st,applied_at:d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,'0')+"-"+String(d.getDate()).padStart(2,'0')+" "+String(d.getHours()).padStart(2,'0')+":"+String(d.getMinutes()).padStart(2,'0')+":00"})});
  appsDetailed=base.map(function(a){var lid=(listings.find(function(l){return l.title===a.ltitle})||listings[0]).id;var loc=(listings.find(function(l){return l.id===lid})||{}).location||'';var dur=(listings.find(function(l){return l.id===lid})||{}).duration||'';var dl=(listings.find(function(l){return l.id===lid})||{}).application_deadline||'';return {id:a.id,status:a.status,applied_at:a.applied_at,uname:a.uname,uemail:a.uemail,uphone:'05'+Math.floor(100000000+Math.random()*89999999),ucity:loc||'الرياض',ulevel:['طالب','خريج','موظف'][Math.floor(Math.random()*3)],supervisor_id:0,lid:lid,ltitle:a.ltitle,lloc:loc,ldur:dur,ldead:dl}});
  localStorage.setItem('tadribi_provider_apps_detailed',JSON.stringify(appsDetailed));
}
function save(){localStorage.setItem('tadribi_provider_listings',JSON.stringify(listings));localStorage.setItem('tadribi_supervisors',JSON.stringify(supervisors));localStorage.setItem('tadribi_provider_apps_detailed',JSON.stringify(appsDetailed))}
function toast(msg){var t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(function(){t.classList.remove('show')},2000)}
function renderKPIs(){var total=appsDetailed.length;var pending=appsDetailed.filter(function(a){return a.status==='pending'}).length;var viewed=appsDetailed.filter(function(a){return a.status==='viewed'}).length;var accepted=appsDetailed.filter(function(a){return a.status==='accepted'}).length;var rejected=appsDetailed.filter(function(a){return a.status==='rejected'}).length;document.getElementById('k_total').textContent=total;document.getElementById('k_pending').textContent=pending;document.getElementById('k_viewed').textContent=viewed;document.getElementById('k_ok').textContent=accepted+' / '+rejected}
function fillListingsSelect(){var s=document.getElementById('listF');s.innerHTML='';var opt=document.createElement('option');opt.value='0';opt.textContent='جميع الفرص';s.appendChild(opt);listings.forEach(function(l){var o=document.createElement('option');o.value=l.id;o.textContent=l.title;s.appendChild(o)});s.value=String(listState)}
function filteredSorted(){var arr=appsDetailed.slice();if(qState){var ql=qState.toLowerCase();arr=arr.filter(function(a){return (a.uname.toLowerCase().includes(ql)||a.uemail.toLowerCase().includes(ql)||a.ltitle.toLowerCase().includes(ql))})}if(statusState){arr=arr.filter(function(a){return a.status===statusState})}if(listState){arr=arr.filter(function(a){return a.lid===listState})}var cmp=function(a,b){return 0};if(sortState==='applied_desc'){cmp=function(a,b){return new Date(b.applied_at)-new Date(a.applied_at)}}
else if(sortState==='applied_asc'){cmp=function(a,b){return new Date(a.applied_at)-new Date(b.applied_at)}}
else if(sortState==='user_asc'){cmp=function(a,b){return a.uname.localeCompare(b.uname,'ar')}}
else if(sortState==='user_desc'){cmp=function(a,b){return b.uname.localeCompare(a.uname,'ar')}}
else if(sortState==='listing_asc'){cmp=function(a,b){return a.ltitle.localeCompare(b.ltitle,'ar')}}
else if(sortState==='listing_desc'){cmp=function(a,b){return b.ltitle.localeCompare(a.ltitle,'ar')}}
else if(sortState==='status_asc'){cmp=function(a,b){return a.status.localeCompare(b.status,'ar')}}
else if(sortState==='status_desc'){cmp=function(a,b){return b.status.localeCompare(a.status,'ar')}}
arr.sort(cmp);return arr}
function renderTable(){var arr=filteredSorted();var total=arr.length;document.getElementById('totalCount').textContent=total;var pages=Math.max(1,Math.ceil(total/per));if(pageState>pages)pageState=pages;var start=(pageState-1)*per;var slice=arr.slice(start,start+per);var tb=document.querySelector('#appsTable tbody');tb.innerHTML='';if(!slice.length){var tr=document.createElement('tr');var td=document.createElement('td');td.colSpan=7;td.className='small';td.textContent='لا توجد بيانات';tr.appendChild(td);tb.appendChild(tr)}else{slice.forEach(function(r){var sOpt='<option value="">اختر مشرفًا</option>'+supervisors.map(function(s){return '<option value="'+s.id+'"'+(Number(r.supervisor_id)===Number(s.id)?' selected':'')+'>'+s.name+' — '+s.email+'</option>'}).join('');var tr=document.createElement('tr');tr.setAttribute('data-id',r.id);tr.innerHTML='<td>'+r.uname+'</td><td>'+r.uemail+'</td><td>'+r.ltitle+'</td><td>'+(r.supervisor_id?supervisors.find(function(s){return s.id===Number(r.supervisor_id)}).name:'<span class="small">— غير معيّن —</span>')+'</td><td>'+r.status+'</td><td class="small">'+r.applied_at+'</td><td><div class="flex" style="flex-wrap:wrap;gap:6px"><form data-role="assign" style="display:flex;gap:6px;align-items:center"><select class="select" name="supervisor_id">'+sOpt+'</select><button class="btn" type="submit" style="padding:6px 10px">تعيين</button></form><button class="btn ghost" data-role="status" data-status="viewed" style="padding:6px 10px">شوهد</button><button class="btn" data-role="status" data-status="accepted" style="padding:6px 10px">قبول</button><button class="btn ghost" data-role="status" data-status="rejected" style="padding:6px 10px">رفض</button><button class="btn ghost" data-role="delete" style="padding:6px 10px;border-color:#f4caca;color:#b11">حذف</button></div></td>';
  tb.appendChild(tr)})}
var pag=document.getElementById('pagination');pag.innerHTML='';for(var i=1;i<=pages;i++){var a=document.createElement('a');a.href="#";a.className='btn '+(i===pageState?'':'ghost');a.textContent=i;a.dataset.page=i;a.style.padding='6px 10px';pag.appendChild(a)}}
function updateStatus(id,st){var it=appsDetailed.find(function(x){return x.id===id});if(!it)return;it.status=st;save();renderKPIs();renderTable();toast('تم تحديث حالة الطلب')}
function assignSupervisor(id,sid){sid=Number(sid);if(!sid){toast('اختر مشرفًا صالحًا');return}var it=appsDetailed.find(function(x){return x.id===id});if(!it)return;var ok=supervisors.find(function(s){return s.id===sid});if(!ok){toast('المشرف غير موجود');return}it.supervisor_id=sid;save();renderTable();toast('تم تعيين المشرف بنجاح')}
function deleteApplication(id){var idx=appsDetailed.findIndex(function(x){return x.id===id});if(idx===-1)return;appsDetailed.splice(idx,1);save();renderKPIs();renderTable();toast('تم حذف الطلب')}
function initMode(){var mb=document.getElementById('mode');var m=localStorage.getItem('mode');if(m==='dark'){document.documentElement.setAttribute('data-mode','dark');mb.textContent='الوضع: ليلي'}else if(m==='light'){document.documentElement.setAttribute('data-mode','light');mb.textContent='الوضع: نهاري'}else{document.documentElement.removeAttribute('data-mode');mb.textContent='الوضع: تلقائي'}mb.addEventListener('click',function(){var html=document.documentElement,cur=html.getAttribute('data-mode');if(cur==='dark'){html.setAttribute('data-mode','light');localStorage.setItem('mode','light');this.textContent='الوضع: نهاري'}else if(cur==='light'){html.removeAttribute('data-mode');localStorage.removeItem('mode');this.textContent='الوضع: تلقائي'}else{html.setAttribute('data-mode','dark');localStorage.setItem('mode','dark');this.textContent='الوضع: ليلي'}})}
function initMenu(){var burger=document.getElementById('burger'),sidebar=document.getElementById('sidebar'),backdrop=document.getElementById('backdrop');function openMenu(){sidebar.classList.add('open');backdrop.classList.add('show');document.body.style.overflow='hidden'}function closeMenu(){sidebar.classList.remove('open');backdrop.classList.remove('show');document.body.style.overflow=''}if(burger)burger.addEventListener('click',openMenu);if(backdrop)backdrop.addEventListener('click',closeMenu);document.querySelectorAll('.menu .link').forEach(function(el){el.addEventListener('click',closeMenu)})}
function initFilters(){document.getElementById('filterForm').addEventListener('submit',function(e){e.preventDefault();qState=document.getElementById('q').value.trim();statusState=document.getElementById('statusF').value;listState=Number(document.getElementById('listF').value||0);sortState=document.getElementById('sort').value;pageState=1;renderTable()})}
function initTableEvents(){var t=document.getElementById('appsTable');t.addEventListener('submit',function(e){var f=e.target.closest('form[data-role="assign"]');if(!f)return;e.preventDefault();var tr=e.target.closest('tr');var id=Number(tr.getAttribute('data-id'));var sid=Number(f.querySelector('select[name="supervisor_id"]').value||0);assignSupervisor(id,sid)});t.addEventListener('click',function(e){var b=e.target.closest('button');if(!b)return;var tr=e.target.closest('tr');var id=Number(tr.getAttribute('data-id'));if(b.dataset.role==='status'){updateStatus(id,b.dataset.status)}else if(b.dataset.role==='delete'){if(confirm('حذف الطلب نهائيًا؟')){deleteApplication(id)}}})}
function initPagination(){document.getElementById('pagination').addEventListener('click',function(e){if(e.target.dataset.page){e.preventDefault();pageState=Number(e.target.dataset.page);renderTable()}})}
function boot(){document.getElementById('hello').textContent='مرحبًا، '+uname;document.getElementById('roleTag').textContent='دور: '+(role||'—');initMode();initMenu();renderKPIs();fillListingsSelect();renderTable();initFilters();initTableEvents();initPagination()}
boot()
</script>
</body>
</html>
